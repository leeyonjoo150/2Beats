<!-- templates/music_explore/detail.html -->

{% extends 'music_explore/base.html' %}

{% block title %}{{ music.music_title }} - TwoBeats{% endblock %}

{% block content %}

<!-- ë©”ì‹œì§€ í‘œì‹œ -->
{% if messages %}
    <div style="margin-bottom: 1rem;">
        {% for message in messages %}
            <div style="
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 0.5rem;
                {% if message.tags == 'success' %}
                    background-color: #d4edda;
                    color: #155724;
                    border: 1px solid #c3e6cb;
                {% elif message.tags == 'error' %}
                    background-color: #f8d7da;
                    color: #721c24;
                    border: 1px solid #f5c6cb;
                {% endif %}
            ">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<!-- ìŒì•… ì •ë³´ -->
<div class="card">
    <div style="display: flex; gap: 2rem; align-items: start;">
        <!-- ì¸ë„¤ì¼ -->
        <div style="min-width: 250px;">
            {% if music.music_thumbnail %}
                <img src="{{ music.music_thumbnail.url }}" 
                     alt="{{ music.music_title }}"
                     style="width: 100%; border-radius: 8px;">
            {% else %}
                <div style="
                    width: 250px; 
                    height: 250px; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 4rem;
                ">
                    ğŸµ
                </div>
            {% endif %}
        </div>
        
        <!-- ì •ë³´ -->
        <div style="flex: 1;">
            <h1 style="margin-bottom: 0.5rem;">{{ music.music_title }}</h1>
            <h2 style="color: #666; margin-bottom: 1.5rem;">{{ music.music_singer }}</h2>
            
            <p style="margin-bottom: 0.5rem;">
                <strong>ì¥ë¥´:</strong> {{ music.get_music_type_display }}
            </p>
            <p style="margin-bottom: 0.5rem;">
                <strong>ì—…ë¡œë”:</strong> {{ music.uploader.username }}
            </p>
            <p style="margin-bottom: 0.5rem;">
                <strong>ì¬ìƒìˆ˜:</strong> {{ music.music_count }}íšŒ
            </p>
            <p style="margin-bottom: 1.5rem;">
                <strong>ì¢‹ì•„ìš”:</strong> <span id="like-count">{{ music.music_like_count }}</span>
            </p>
            
            <!-- íƒœê·¸ -->
            {% if music.tags.all %}
                <div style="margin-bottom: 1.5rem;">
                    {% for tag in music.tags.all %}
                        <span style="
                            display: inline-block;
                            background-color: #f0f0f0;
                            padding: 0.3rem 0.8rem;
                            border-radius: 15px;
                            margin-right: 0.5rem;
                            font-size: 0.9rem;
                        ">
                            #{{ tag.name }}
                        </span>
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- ë²„íŠ¼ë“¤ -->
            <div style="display: flex; gap: 1rem;">
                <!-- ì¢‹ì•„ìš” ë²„íŠ¼ (AJAX) -->
                {% if user.is_authenticated %}
                    <button 
                        id="like-btn"
                        onclick="toggleLike({{ music.id }})"
                        class="btn {% if is_liked %}btn-primary{% else %}btn-secondary{% endif %}"
                        data-liked="{% if is_liked %}true{% else %}false{% endif %}"
                    >
                        <span id="like-text">{% if is_liked %}â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ{% else %}ğŸ¤ ì¢‹ì•„ìš”{% endif %}</span>
                    </button>
                {% else %}
                    <a href="/admin/" class="btn btn-secondary">ğŸ¤ ì¢‹ì•„ìš” (ë¡œê·¸ì¸ í•„ìš”)</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ìŒì•… ì¬ìƒ í”Œë ˆì´ì–´ -->
{% if music.music_root %}
<div class="card">
    <h2 style="margin-bottom: 1rem;">ğŸµ ìŒì•… ì¬ìƒ</h2>
    <audio controls style="width: 100%;">
        <source src="{{ music.music_root.url }}" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
</div>
{% endif %}

<!-- ëŒ“ê¸€ -->
<div class="card">
    <h2 style="margin-bottom: 1.5rem;">ğŸ’¬ ëŒ“ê¸€ ({{ comments.count }})</h2>
    
    <!-- ëŒ“ê¸€ ì‘ì„± -->
    {% if user.is_authenticated %}
        <form method="POST" action="{% url 'music_explore:comment' music.id %}" style="margin-bottom: 2rem;">
            {% csrf_token %}
            <textarea 
                name="content" 
                rows="3" 
                class="search-box"
                placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                style="border-radius: 8px; margin-bottom: 0.5rem;"
                required
            ></textarea>
            <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
        </form>
    {% else %}
        <p style="text-align: center; color: #999; padding: 1rem; background-color: #f9f9f9; border-radius: 8px; margin-bottom: 2rem;">
            ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/admin/" style="color: #1db954;">ë¡œê·¸ì¸</a>í•˜ì„¸ìš”.
        </p>
    {% endif %}
    
    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    {% if comments %}
        <div style="display: grid; gap: 1rem;">
            {% for comment in comments %}
                <div style="
                    padding: 1rem;
                    border-left: 3px solid #1db954;
                    background-color: #f9f9f9;
                    border-radius: 4px;
                ">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: center;">
                        <div>
                            <strong>{{ comment.user.username }}</strong>
                            <span style="color: #999; font-size: 0.9rem; margin-left: 1rem;">
                                {{ comment.created_at|date:"Y-m-d H:i" }}
                            </span>
                        </div>
                        
                        <!-- ì‚­ì œ ë²„íŠ¼ (ë³¸ì¸ ëŒ“ê¸€ë§Œ) -->
                        {% if user == comment.user %}
                            <form method="POST" 
                                  action="{% url 'music_explore:comment_delete' comment.id %}" 
                                  style="margin: 0;"
                                  onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                {% csrf_token %}
                                <button type="submit" style="
                                    background: none;
                                    border: none;
                                    color: #ff4444;
                                    cursor: pointer;
                                    font-size: 0.9rem;
                                    padding: 0.3rem 0.6rem;
                                    transition: color 0.3s;
                                " onmouseover="this.style.color='#cc0000'" 
                                   onmouseout="this.style.color='#ff4444'">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>
                            </form>
                        {% endif %}
                    </div>
                    <p>{{ comment.content }}</p>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="text-align: center; color: #999; padding: 2rem;">
            ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!
        </p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ì¢‹ì•„ìš” í† ê¸€ (AJAX)
function toggleLike(musicId) {
    const likeBtn = document.getElementById('like-btn');
    const likeText = document.getElementById('like-text');
    const likeCount = document.getElementById('like-count');
    const isLiked = likeBtn.dataset.liked === 'true';
    
    // ì„œë²„ì— ìš”ì²­
    fetch(`/music/like/${musicId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(response => response.json())
    .then(data => {
        // UI ì—…ë°ì´íŠ¸
        if (data.is_liked) {
            likeBtn.classList.remove('btn-secondary');
            likeBtn.classList.add('btn-primary');
            likeText.textContent = 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ';
            likeBtn.dataset.liked = 'true';
        } else {
            likeBtn.classList.remove('btn-primary');
            likeBtn.classList.add('btn-secondary');
            likeText.textContent = 'ğŸ¤ ì¢‹ì•„ìš”';
            likeBtn.dataset.liked = 'false';
        }
        
        // ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
        likeCount.textContent = data.like_count;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}
</script>
{% endblock %}