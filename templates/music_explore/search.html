<!--
  ========================================
  ìŒì•… ê²€ìƒ‰ í˜ì´ì§€ (Music Search)
  ========================================
  - ì œëª©/ê°€ìˆ˜ ê²€ìƒ‰ ë° ìë™ì™„ì„±
  - ì¥ë¥´ ë° íƒœê·¸ í•„í„°ë§
  - ê²€ìƒ‰ ê¸°ë¡ ì €ì¥ ë° í‘œì‹œ
  - í˜ì´ì§€ë„¤ì´ì…˜
-->

{% extends 'music_explore/base.html' %}
{% block title %}ìŒì•… ê²€ìƒ‰ - TwoBeats{% endblock %}

{% block extra_css %}
<style>
  /* ========================================
     í˜ì´ì§€ í—¤ë”
     ======================================== */
  .page-header {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .page-header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    color: white;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* ========================================
     ìë™ì™„ì„± ì»¨í…Œì´ë„ˆ
     ======================================== */
  .autocomplete-container {
    position: relative;
  }

  .autocomplete-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(18,15,31,0.98);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.12);
    border-top: none;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    display: none;
    z-index: 10000;
    max-height: 320px;
    overflow-y: auto;
  }

  .autocomplete-results.active {
    display: block;
  }

  /* ìë™ì™„ì„± ì•„ì´í…œ */
  .autocomplete-item {
    padding: 0.9rem 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.8rem;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    transition: background-color 0.15s;
  }

  .autocomplete-item:last-child {
    border-bottom: none;
  }

  .autocomplete-item:hover {
    background: rgba(255,255,255,0.05);
  }

  .autocomplete-item.selected {
    background: rgba(192,132,252,0.12);
  }

  /* ìë™ì™„ì„± íƒ€ì… ë°°ì§€ */
  .autocomplete-type {
    font-size: 0.7rem;
    padding: 0.25rem 0.6rem;
    border-radius: 20px;
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .type-title {
    background: linear-gradient(135deg, #c084fc, #7c3aed);
  }

  .type-singer {
    background: linear-gradient(135deg, #818cf8, #6366f1);
  }

  /* ========================================
     í•„í„° ì˜ì—­
     ======================================== */
  .filter-row {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  .filter-select {
    flex: 1;
    min-width: 150px;
    padding: 0.8rem 1rem;
    border: 2px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
    color: white;
  }

  .filter-select option {
    background: #120f1f;
    color: white;
  }

  .filter-select:focus {
    outline: none;
    border-color: #c084fc;
    background: rgba(255,255,255,0.08);
    box-shadow: 0 0 0 3px rgba(192,132,252,0.15);
  }

  /* ========================================
     ê²°ê³¼ í—¤ë”
     ======================================== */
  .result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.2rem;
  }

  .result-header h2 {
    font-size: 1.2rem;
    font-weight: 600;
    color: white;
  }

  .result-count {
    color: rgba(255,255,255,0.5);
    font-size: 0.9rem;
    font-weight: 500;
  }

  /* ========================================
     ìŒì•… ì¹´ë“œ
     ======================================== */
  .music-list {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }

  .music-card {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(8px);
    border-radius: 12px;
    gap: 1rem;
    transition: all 0.2s ease;
    border: 1px solid rgba(255,255,255,0.06);
  }

  .music-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(192,132,252,0.15);
    border-color: rgba(192,132,252,0.2);
    background: rgba(255,255,255,0.05);
  }

  .music-thumbnail {
    width: 56px;
    height: 56px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .music-thumbnail-placeholder {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #c084fc, #7c3aed);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(124,58,237,0.3);
  }

  .music-info {
    flex: 1;
    min-width: 0;
  }

  .music-title {
    font-weight: 600;
    color: white;
    text-decoration: none;
    font-size: 0.95rem;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.2s;
  }

  .music-title:hover {
    color: #c084fc;
  }

  .music-artist {
    color: rgba(255,255,255,0.5);
    font-size: 0.85rem;
    margin-top: 0.2rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .music-play-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #c084fc, #7c3aed);
    border: none;
    color: white;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(192,132,252,0.3);
    flex-shrink: 0;
  }

  .music-play-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(192,132,252,0.5);
  }

  /* ========================================
     í˜ì´ì§€ë„¤ì´ì…˜
     ======================================== */
  .pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
    flex-wrap: wrap;
  }

  .pagination a,
  .pagination span {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .pagination a {
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.7);
    border: 1px solid rgba(255,255,255,0.1);
  }

  .pagination a:hover {
    background: rgba(192,132,252,0.12);
    border-color: rgba(192,132,252,0.3);
    color: white;
  }

  .pagination .current {
    background: linear-gradient(135deg, #c084fc, #7c3aed);
    color: white;
    border: none;
  }

  /* ========================================
     ë¹ˆ ìƒíƒœ
     ======================================== */
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: rgba(255,255,255,0.4);
  }

  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .empty-state-text {
    font-size: 1rem;
  }

  /* ========================================
     ê²€ìƒ‰ ê¸°ë¡
     ======================================== */
  .search-history {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.08);
  }

  .history-item {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 0.4rem 0.9rem;
    font-size: 0.85rem;
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    transition: all 0.2s;
  }

  .history-item:hover {
    background: rgba(192,132,252,0.12);
    border-color: rgba(192,132,252,0.3);
    color: white;
  }

  /* ========================================
     ì¹´ë“œ ì»¨í…Œì´ë„ˆ
     ======================================== */
  .card {
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  /* ê²€ìƒ‰ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ë®ì–´ì“°ê¸° */
  .search-box {
    width: 100%;
    padding: 0.875rem 1.25rem;
    border: 2px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    font-size: 1rem;
    color: white;
    transition: all 0.2s;
  }

  .search-box::placeholder {
    color: rgba(255,255,255,0.4);
  }

  .search-box:focus {
    outline: none;
    border-color: #c084fc;
    background: rgba(255,255,255,0.08);
    box-shadow: 0 0 0 3px rgba(192,132,252,0.15);
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1>ğŸ” ìŒì•… ê²€ìƒ‰</h1>
</div>

<!-- ========================================
     ê²€ìƒ‰ í¼
     ======================================== -->
<div class="card">
  <form method="GET" action="{% url 'music_explore:search' %}">
    <div class="autocomplete-container">
      <input
        type="text"
        name="q"
        class="search-box"
        id="search-input"
        placeholder="ì œëª© ë˜ëŠ” ê°€ìˆ˜ë¡œ ê²€ìƒ‰..."
        value="{{ query }}"
        autocomplete="off"
      >
      <div class="autocomplete-results" id="autocomplete-results"></div>
    </div>

    <div class="filter-row">
      <!-- ì¥ë¥´ í•„í„° -->
      <select name="genre" class="filter-select">
        <option value="">ì „ì²´ ì¥ë¥´</option>
        <option value="pop" {% if genre == 'pop' %}selected{% endif %}>Pop</option>
        <option value="ballad" {% if genre == 'ballad' %}selected{% endif %}>Ballad</option>
        <option value="hiphop" {% if genre == 'hiphop' %}selected{% endif %}>Hip-Hop</option>
        <option value="rnb" {% if genre == 'rnb' %}selected{% endif %}>R&B</option>
        <option value="rock" {% if genre == 'rock' %}selected{% endif %}>Rock</option>
        <option value="dance" {% if genre == 'dance' %}selected{% endif %}>Dance</option>
        <option value="indie" {% if genre == 'indie' %}selected{% endif %}>Indie</option>
      </select>

      <!-- íƒœê·¸ í•„í„° -->
      <select name="tag" class="filter-select">
        <option value="">ì „ì²´ íƒœê·¸</option>
        {% for t in all_tags %}
          <option value="{{ t.name }}" {% if tag == t.name %}selected{% endif %}>#{{ t.name }}</option>
        {% endfor %}
      </select>

      <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
    </div>
  </form>
  <div id="search-history" class="search-history" style="display: none;"></div>
</div>

<!-- ========================================
     ê²€ìƒ‰ ê²°ê³¼
     ======================================== -->
<div class="card">
  <div class="result-header">
    <h2>ê²€ìƒ‰ ê²°ê³¼</h2>
    <span class="result-count">{{ musics.paginator.count }}ê³¡</span>
  </div>

  {% if musics %}
    <div class="music-list">
      {% for music in musics %}
        <div class="music-card">
          <!-- ì¸ë„¤ì¼ -->
          {% if music.music_thumbnail %}
            <img src="{{ music.music_thumbnail.url }}" class="music-thumbnail" alt="{{ music.music_title }}">
          {% else %}
            <div class="music-thumbnail-placeholder">ğŸµ</div>
          {% endif %}

          <!-- ì •ë³´ -->
          <div class="music-info">
            <a href="{% url 'music_explore:detail' music.id %}" class="music-title">
              {{ music.music_title }}
            </a>
            <p class="music-artist">{{ music.music_singer }}</p>
          </div>

          <!-- ì¬ìƒ ë²„íŠ¼ -->
          {% if music.music_root %}
          <button
            class="music-play-btn"
            data-id="{{ music.id }}"
            data-title="{{ music.music_title }}"
            data-singer="{{ music.music_singer }}"
            data-url="{{ music.music_root.url }}"
            data-thumb="{% if music.music_thumbnail %}{{ music.music_thumbnail.url }}{% endif %}"
            onclick="playMusicFromData(this)"
          >
            â–¶
          </button>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    {% if musics.has_other_pages %}
    <div class="pagination">
      {% if musics.has_previous %}
        <a href="?q={{ query }}&genre={{ genre }}&tag={{ tag }}&page=1">ì²˜ìŒ</a>
        <a href="?q={{ query }}&genre={{ genre }}&tag={{ tag }}&page={{ musics.previous_page_number }}">ì´ì „</a>
      {% endif %}

      <span class="current">{{ musics.number }} / {{ musics.paginator.num_pages }}</span>

      {% if musics.has_next %}
        <a href="?q={{ query }}&genre={{ genre }}&tag={{ tag }}&page={{ musics.next_page_number }}">ë‹¤ìŒ</a>
        <a href="?q={{ query }}&genre={{ genre }}&tag={{ tag }}&page={{ musics.paginator.num_pages }}">ë§ˆì§€ë§‰</a>
      {% endif %}
    </div>
    {% endif %}
  {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">ğŸµ</div>
      <p class="empty-state-text">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
const searchInput = document.getElementById('search-input');
const autocompleteResults = document.getElementById('autocomplete-results');
let selectedIndex = -1;
let debounceTimer;

// ì…ë ¥ ì‹œ ìë™ì™„ì„±
searchInput.addEventListener('input', function() {
  clearTimeout(debounceTimer);
  const query = this.value.trim();

  if (query.length < 1) {
    autocompleteResults.classList.remove('active');
    return;
  }

  // 300ms í›„ì— ê²€ìƒ‰
  debounceTimer = setTimeout(() => {
    fetch(`/music/autocomplete/?q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        if (data.results.length > 0) {
          renderAutocomplete(data.results);
        } else {
          autocompleteResults.classList.remove('active');
        }
      });
  }, 300);
});

// ìë™ì™„ì„± ë Œë”ë§
function renderAutocomplete(results) {
  selectedIndex = -1;
  autocompleteResults.innerHTML = results.map((item, index) => `
    <div class="autocomplete-item" data-value="${item.value}" data-index="${index}">
      <span class="autocomplete-type ${item.type === 'title' ? 'type-title' : 'type-singer'}">
        ${item.type === 'title' ? 'ì œëª©' : 'ê°€ìˆ˜'}
      </span>
      <span>${item.value}</span>
    </div>
  `).join('');

  autocompleteResults.classList.add('active');

  // í´ë¦­ ì´ë²¤íŠ¸
  document.querySelectorAll('.autocomplete-item').forEach(item => {
    item.addEventListener('click', function() {
      searchInput.value = this.dataset.value;
      autocompleteResults.classList.remove('active');
      searchInput.closest('form').submit();
    });
  });
}

// í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
searchInput.addEventListener('keydown', function(e) {
  const items = document.querySelectorAll('.autocomplete-item');

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
    updateSelected(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    selectedIndex = Math.max(selectedIndex - 1, -1);
    updateSelected(items);
  } else if (e.key === 'Enter' && selectedIndex >= 0) {
    e.preventDefault();
    searchInput.value = items[selectedIndex].dataset.value;
    autocompleteResults.classList.remove('active');
    searchInput.closest('form').submit();
  } else if (e.key === 'Escape') {
    autocompleteResults.classList.remove('active');
  }
});

function updateSelected(items) {
  items.forEach((item, index) => {
    if (index === selectedIndex) {
      item.classList.add('selected');
    } else {
      item.classList.remove('selected');
    }
  });
}

// ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
  if (!searchInput.contains(e.target) && !autocompleteResults.contains(e.target)) {
    autocompleteResults.classList.remove('active');
  }
});

const MAX_HISTORY = 5;

function saveSearchHistory(query) {
  if (!query.trim()) return;

  let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');

  // ì¤‘ë³µ ì œê±°
  history = history.filter(item => item !== query);

  // ë§¨ ì•ì— ì¶”ê°€
  history.unshift(query);

  // ìµœëŒ€ 5ê°œë§Œ ìœ ì§€
  history = history.slice(0, MAX_HISTORY);

  localStorage.setItem('searchHistory', JSON.stringify(history));
}

function getSearchHistory() {
  return JSON.parse(localStorage.getItem('searchHistory') || '[]');
}

function renderSearchHistory() {
  const history = getSearchHistory();
  const container = document.getElementById('search-history');

  if (history.length === 0 || !container) return;

  container.innerHTML = history.map(item => `
    <button class="history-item" onclick="searchFromHistory('${item}')">
      ğŸ• ${item}
    </button>
  `).join('');

  container.style.display = 'flex';
}

function searchFromHistory(query) {
  document.getElementById('search-input').value = query;
  document.getElementById('search-input').closest('form').submit();
}

function clearSearchHistory() {
  localStorage.removeItem('searchHistory');
  const container = document.getElementById('search-history');
  if (container) {
    container.style.display = 'none';
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ
document.addEventListener('DOMContentLoaded', function() {
  renderSearchHistory();

  // ê²€ìƒ‰ ì‹œ ê¸°ë¡ ì €ì¥
  const form = document.getElementById('search-input').closest('form');
  form.addEventListener('submit', function() {
    const query = document.getElementById('search-input').value;
    saveSearchHistory(query);
  });
});
</script>
{% endblock %}
