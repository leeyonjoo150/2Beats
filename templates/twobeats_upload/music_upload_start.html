{% extends "base.html" %}
{% block title %}ìŒì•… ì—…ë¡œë“œ | 2beats{% endblock %}

{% block extra_head %}
<style>
  /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
  .upload-container {
    max-width: 56rem;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .upload-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .upload-header h1 {
    margin: 0 0 0.75rem;
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #ffffff 0%, #c084fc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .upload-header p {
    margin: 0;
    color: rgba(255,255,255,0.6);
    font-size: 1rem;
  }

  .upload-dropzone {
    background: rgba(255,255,255,0.03);
    border: 2px dashed rgba(192,132,252,0.3);
    border-radius: 1.25rem;
    padding: 4rem 2rem;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .upload-dropzone:hover {
    background: rgba(255,255,255,0.05);
    border-color: rgba(192,132,252,0.5);
    transform: translateY(-2px);
  }

  .upload-dropzone::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 120px;
    height: 120px;
    background: radial-gradient(circle, rgba(192,132,252,0.1) 0%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
  }

  .upload-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(192,132,252,0.15);
    position: relative;
    z-index: 1;
  }

  .upload-text-main {
    font-size: 1.25rem;
    font-weight: 600;
    color: white;
    margin-bottom: 1rem;
    position: relative;
    z-index: 1;
  }

  .upload-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 2rem;
    background: linear-gradient(120deg, #c084fc, #7c3aed);
    color: white;
    border: none;
    border-radius: 2rem;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    margin: 1rem 0;
    position: relative;
    z-index: 1;
  }

  .upload-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(124,58,237,0.4);
  }

  .upload-text-sub {
    color: rgba(255,255,255,0.5);
    font-size: 0.875rem;
    margin-top: 0.5rem;
    position: relative;
    z-index: 1;
  }

  .upload-info {
    margin-top: 2rem;
    padding: 1.5rem;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 1rem;
  }

  .upload-info h3 {
    margin: 0 0 1rem;
    font-size: 1.125rem;
    color: white;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .upload-info ul {
    margin: 0;
    padding-left: 1.5rem;
    color: rgba(255,255,255,0.6);
    line-height: 1.8;
  }

  .form-errors {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: rgba(248,113,113,0.1);
    border: 1px solid rgba(248,113,113,0.3);
    border-radius: 0.75rem;
    color: #fecaca;
  }

  /* ğŸ”¥ ì—ëŸ¬ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
  .error-alert {
    position: fixed;
    top: 2rem;
    right: 2rem;
    background: rgba(248,113,113,0.95);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 0.75rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    z-index: 9999;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @media (max-width: 768px) {
    .upload-header h1 { font-size: 2rem; }
    .upload-dropzone { padding: 3rem 1.5rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
  <div class="upload-header">
    <h1>ìŒì•… íŒŒì¼ ì—…ë¡œë“œ</h1>
    <p>ê³ í’ˆì§ˆ ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ì „ ì„¸ê³„ì™€ ê³µìœ í•˜ì„¸ìš”</p>
  </div>

  {% if form.music_root.errors %}
    <div class="form-errors">
      {{ form.music_root.errors }}
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" id="upload-form">
    {% csrf_token %}

    <div class="upload-dropzone" onclick="document.getElementById('id_music_root').click()">
      <div class="upload-icon">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#c084fc" stroke-width="2">
          <path d="M9 18V5l12-2v13"></path>
          <circle cx="6" cy="18" r="3"></circle>
          <circle cx="18" cy="16" r="3"></circle>
        </svg>
      </div>

      <div class="upload-text-main">
        ì˜¤ë””ì˜¤ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ
      </div>

      <button type="button" class="upload-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        íŒŒì¼ ì„ íƒ
      </button>

      <div class="upload-text-sub">
        ë˜ëŠ” í´ë¦­í•˜ì—¬ ê¸°ê¸°ì—ì„œ ì„ íƒí•˜ì„¸ìš”
      </div>
    </div>

    {{ form.music_root }}
  </form>

  <div class="upload-info">
    <h3>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#c084fc" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12.01" y2="8"></line>
      </svg>
      ì—…ë¡œë“œ ê°€ì´ë“œ
    </h3>
    <ul>
      <li>ìµœê³ ì˜ í’ˆì§ˆì„ ìœ„í•´ WAV, FLAC, AIFF ë˜ëŠ” ALAC í˜•ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”</li>
      <li>MP3 íŒŒì¼ë„ ì§€ì›ë©ë‹ˆë‹¤ (ìµœì†Œ 192kbps ê¶Œì¥)</li>
      <li>íŒŒì¼ í¬ê¸° ì œí•œ: ìµœëŒ€ 100MB</li>
      <li>í—ˆìš© í˜•ì‹: MP3, WAV, FLAC, AIFF, ALAC, M4A, OGG</li>
    </ul>
  </div>
</div>

<script>
  // ğŸ”¥ í—ˆìš© í™•ì¥ì ëª©ë¡
  const VALID_AUDIO_EXTENSIONS = ['.mp3', '.wav', '.flac', '.aiff', '.alac', '.m4a', '.ogg', '.wma', '.aac'];
  const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB

  // ğŸ”¥ íŒŒì¼ ê²€ì¦ í•¨ìˆ˜
  function validateAudioFile(file) {
    // í™•ì¥ì ì²´í¬
    const fileName = file.name.toLowerCase();
    const hasValidExtension = VALID_AUDIO_EXTENSIONS.some(ext => fileName.endsWith(ext));
    
    if (!hasValidExtension) {
      return {
        valid: false,
        message: `ìŒì•… íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\ní—ˆìš© í˜•ì‹: ${VALID_AUDIO_EXTENSIONS.join(', ')}`
      };
    }
    
    // íŒŒì¼ í¬ê¸° ì²´í¬
    if (file.size > MAX_FILE_SIZE) {
      return {
        valid: false,
        message: `íŒŒì¼ í¬ê¸°ëŠ” 100MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní˜„ì¬ íŒŒì¼ í¬ê¸°: ${(file.size / 1024 / 1024).toFixed(2)}MB`
      };
    }
    
    // MIME íƒ€ì… ì²´í¬
    const validMimeTypes = [
      'audio/mpeg', 'audio/wav', 'audio/x-wav', 'audio/flac', 'audio/x-flac',
      'audio/aiff', 'audio/x-aiff', 'audio/mp4', 'audio/x-m4a', 'audio/ogg'
    ];
    
    if (file.type && !validMimeTypes.includes(file.type)) {
      return {
        valid: false,
        message: `ì˜¬ë°”ë¥¸ ìŒì•… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.\nMIME íƒ€ì…: ${file.type}`
      };
    }
    
    return { valid: true };
  }

  // ğŸ”¥ ì—ëŸ¬ ì•Œë¦¼ í‘œì‹œ
  function showError(message) {
    // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
    const existing = document.querySelector('.error-alert');
    if (existing) existing.remove();
    
    // ìƒˆ ì•Œë¦¼ ìƒì„±
    const alert = document.createElement('div');
    alert.className = 'error-alert';
    alert.textContent = message;
    document.body.appendChild(alert);
    
    // 5ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
      alert.remove();
    }, 5000);
  }

  const fileInput = document.getElementById('id_music_root');
  if (fileInput) {
    fileInput.style.display = 'none';
    
    // accept ì†ì„± ì¶”ê°€
    fileInput.setAttribute('accept', 'audio/*,.mp3,.wav,.flac,.aiff,.alac,.m4a,.ogg');

    // ğŸ”¥ íŒŒì¼ ì„ íƒ ì‹œ ê²€ì¦
    fileInput.addEventListener('change', function () {
      if (this.files.length > 0) {
        const file = this.files[0];
        const validation = validateAudioFile(file);
        
        if (!validation.valid) {
          showError(validation.message);
          this.value = ''; // íŒŒì¼ ì„ íƒ ì·¨ì†Œ
          return;
        }
        
        // ê²€ì¦ í†µê³¼ â†’ í¼ ì œì¶œ
        this.form.submit();
      }
    });

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
    const dropzone = document.querySelector('.upload-dropzone');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      }, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      dropzone.addEventListener(eventName, () => {
        dropzone.style.background = 'rgba(255,255,255,0.08)';
        dropzone.style.borderColor = '#c084fc';
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, () => {
        dropzone.style.background = 'rgba(255,255,255,0.03)';
        dropzone.style.borderColor = 'rgba(192,132,252,0.3)';
      }, false);
    });

    // ğŸ”¥ ë“œë¡­ ì‹œ ê²€ì¦
    dropzone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;

      if (files.length > 0) {
        const file = files[0];
        const validation = validateAudioFile(file);
        
        if (!validation.valid) {
          showError(validation.message);
          return;
        }
        
        fileInput.files = files;
        document.getElementById('upload-form').submit();
      }
    }, false);
  }
</script>
{% endblock %}