{% extends "base.html" %}

{% block content %}
<div class="tb-upload-page">

  <!-- ìƒë‹¨ í—¤ë” -->
  <div class="tb-upload-header">
    <h1 class="tb-page-title">Video Info</h1>
    <p class="tb-page-subtitle">ì˜ìƒ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ì¸ë„¤ì¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>
  </div>

  <form method="post" enctype="multipart/form-data" class="tb-upload-form" id="video-form">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="tb-form-errors">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <!-- ğŸ”¥ ì™¼ìª½/ì˜¤ë¥¸ìª½ 2ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ -->
    <div class="tb-upload-layout">

      <!-- ì™¼ìª½: ì¸ë„¤ì¼ -->
      <section class="tb-upload-left">
        <div class="tb-artwork-card"
          tabindex="-1"
          onclick="document.getElementById('id_video_thumbnail').click()">

          <img
            id="tb-artwork-preview"
            class="tb-artwork-preview"
            alt="Thumbnail"
            src="{% if video and video.video_thumbnail %}{{ video.video_thumbnail.url }}{% endif %}"
            {% if not video or not video.video_thumbnail %}style="display:none;"{% endif %}
          >

          <div id="tb-artwork-placeholder"
              class="tb-artwork-placeholder"
              {% if video and video.video_thumbnail %}style="display:none;"{% endif %}>
            <div class="tb-artwork-icon">
              <svg width="48" height="48" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="1.5"
                  stroke-linecap="round" stroke-linejoin="round">
                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
              </svg>
            </div>
            <span class="tb-artwork-text">Add new thumbnail</span>
            <span class="tb-artwork-hint">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</span>
          </div>
        </div>

        {{ form.video_thumbnail }}

        {% if form.video_thumbnail.errors %}
          <div class="tb-field-error">
            {{ form.video_thumbnail.errors }}
          </div>
        {% endif %}
      </section>


      <!-- ì˜¤ë¥¸ìª½: ì…ë ¥ í•„ë“œ ì „ì²´ -->
      <section class="tb-upload-right">

        <!-- Title -->
        <div class="tb-field-row">
          <label class="tb-label" for="id_video_title">
            <span class="tb-label-text">Title</span>
            <span class="tb-required">*</span>
          </label>
          <div class="tb-field-main">
            {{ form.video_title }}
            {% if form.video_title.errors %}
              <div class="tb-field-error">
                {{ form.video_title.errors }}
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Artist -->
        <div class="tb-field-row">
          <label class="tb-label" for="id_video_singer">
            <span class="tb-label-text">Artist</span>
            <span class="tb-required">*</span>
          </label>
          <div class="tb-field-main">
            {{ form.video_singer }}
            {% if form.video_singer.errors %}
              <div class="tb-field-error">
                {{ form.video_singer.errors }}
              </div>
            {% endif %}
            <p class="tb-help-text">
              ì—¬ëŸ¬ ëª…ì¼ ê²½ìš° ì‰¼í‘œë¡œ êµ¬ë¶„í•´ë„ ì¢‹ì•„ìš”
            </p>
          </div>
        </div>

        <!-- Type -->
        <div class="tb-field-row">
          <label class="tb-label" for="id_video_type">
            <span class="tb-label-text">Type</span>
            <span class="tb-required">*</span>
          </label>
          <div class="tb-field-main">
            {{ form.video_type }}
            {% if form.video_type.errors %}
              <div class="tb-field-error">
                {{ form.video_type.errors }}
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Tags -->
        <div class="tb-field-row">
          <label class="tb-label">
            <span class="tb-label-text">Tags</span>
          </label>
          <div class="tb-field-main">
            
            <div class="tb-tags-grid">
              {% for tag in form.tags.field.queryset %}
                <label class="tb-tag-checkbox" for="tag_{{ tag.id }}">
                  <input 
                    type="checkbox" 
                    name="tags" 
                    value="{{ tag.id }}"
                    id="tag_{{ tag.id }}"
                    {% if tag in form.instance.tags.all %}checked{% endif %}
                  >
                  <span class="tb-tag-label">#{{ tag.name }}</span>
                </label>
              {% empty %}
                <div class="tb-alert-warning">
                  âš ï¸ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. <code>python manage.py init_tags</code> ì‹¤í–‰í•˜ì„¸ìš”.
                </div>
              {% endfor %}
            </div>
            
            {% if form.tags.errors %}
              <div class="tb-field-error">
                {{ form.tags.errors }}
              </div>
            {% endif %}
            
            <p class="tb-help-text">
              ì˜ìƒ ë¶„ìœ„ê¸°, ì¥ë¥´ ë“±ì— ë§ëŠ” íƒœê·¸ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš” (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)
            </p>
          </div>
        </div>

        <!-- Description -->
        <div class="tb-field-row">
          <label class="tb-label" for="id_video_detail">
            <span class="tb-label-text">Description</span>
          </label>
          <div class="tb-field-main">
            {{ form.video_detail }}
            {% if form.video_detail.errors %}
              <div class="tb-field-error">
                {{ form.video_detail.errors }}
              </div>
            {% endif %}
            <p class="tb-help-text">
              ì˜ìƒì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”
            </p>
          </div>
        </div>

      </section>

    </div>  <!-- /.tb-upload-layout -->

    <!-- ğŸ”¥ í•˜ë‹¨ ë²„íŠ¼ -->
    <div class="tb-upload-footer">
      <a href="{% url 'twobeats_upload:video_list' %}" class="tb-btn-cancel" id="cancel-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span>ì·¨ì†Œ</span>
      </a>
      <button type="submit" class="tb-btn-submit">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        <span>ì €ì¥ í›„ ì™„ë£Œ</span>
      </button>
    </div>
  </form>
  
</div>

<script>
(function () {
  // ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°
  const input = document.getElementById('id_video_thumbnail');
  const img = document.getElementById('tb-artwork-preview');
  const placeholder = document.getElementById('tb-artwork-placeholder');

  if (input && img) {
    input.addEventListener('change', function () {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        
        // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('ì´ë¯¸ì§€ íŒŒì¼ì€ 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          this.value = '';
          return;
        }
        
        const url = URL.createObjectURL(file);
        img.src = url;
        img.style.display = 'block';

        if (placeholder) {
          placeholder.style.display = 'none';
        }
      }
    });
  }

  // ì·¨ì†Œ ë²„íŠ¼ í™•ì¸
  const cancelBtn = document.getElementById('cancel-btn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function(e) {
      const form = document.getElementById('video-form');
      let hasChanges = false;
      
      // í¼ ë³€ê²½ ê°ì§€
      const inputs = form.querySelectorAll('input[type="text"], textarea, select');
      inputs.forEach(input => {
        if (input.value && input.value.trim() !== '') {
          hasChanges = true;
        }
      });
      
      const fileInput = document.getElementById('id_video_thumbnail');
      if (fileInput && fileInput.files.length > 0) {
        hasChanges = true;
      }
      
      // ë³€ê²½ì‚¬í•­ ìˆìœ¼ë©´ í™•ì¸
      if (hasChanges) {
        if (!confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          e.preventDefault();
        }
      }
    });
  }
})();
</script>

<style>
/* ========================================
   ì „ì²´ ë ˆì´ì•„ì›ƒ
   ======================================== */
.tb-upload-page {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

.tb-upload-header {
  margin-bottom: 2.5rem;
  text-align: center;
}

.tb-page-title {
  font-size: 2.5rem;
  font-weight: 700;
  color: #ffffff;
  margin: 0 0 0.5rem 0;
  background: linear-gradient(135deg, #c084fc, #7c3aed);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.tb-page-subtitle {
  color: #94a3b8;
  font-size: 1rem;
  margin: 0;
}

/* ========================================
   2ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ
   ======================================== */
.tb-upload-layout {
  display: grid;
  grid-template-columns: 380px 1fr;
  gap: 3rem;
  margin-bottom: 2rem;
}

@media (max-width: 1024px) {
  .tb-upload-layout {
    grid-template-columns: 1fr;
    gap: 2rem;
  }
}

/* ========================================
   ì™¼ìª½: ì¸ë„¤ì¼
   ======================================== */
.tb-upload-left {
  position: sticky;
  top: 2rem;
  height: fit-content;
}

.tb-artwork-card {
  position: relative;
  width: 100%;
  aspect-ratio: 1;
  background: rgba(255, 255, 255, 0.03);
  border: 2px dashed rgba(255, 255, 255, 0.15);
  border-radius: 1rem;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s;
}

.tb-artwork-card:hover {
  border-color: rgba(192, 132, 252, 0.5);
  background: rgba(192, 132, 252, 0.05);
  transform: translateY(-2px);
}

.tb-artwork-card:focus {
  outline: 2px solid #c084fc;
  outline-offset: 2px;
}

.tb-artwork-preview {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.tb-artwork-placeholder {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1rem;
}

.tb-artwork-icon {
  color: #64748b;
  transition: all 0.3s;
}

.tb-artwork-card:hover .tb-artwork-icon {
  color: #c084fc;
  transform: scale(1.1);
}

.tb-artwork-text {
  font-size: 1.125rem;
  font-weight: 600;
  color: #cbd5e1;
}

.tb-artwork-hint {
  font-size: 0.875rem;
  color: #64748b;
}

/* íŒŒì¼ input ìˆ¨ê¸°ê¸° */
#id_music_thumbnail,
#id_video_thumbnail {
  display: none;
}

/* ========================================
   ì˜¤ë¥¸ìª½: ì…ë ¥ í•„ë“œ
   ======================================== */
.tb-upload-right {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.tb-field-row {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.tb-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 1rem;
  font-weight: 600;
  color: #e2e8f0;
}

.tb-label-text {
  color: #e2e8f0;
}

.tb-required {
  color: #f87171;
  font-size: 1.25rem;
}

.tb-field-main {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

/* Input ìŠ¤íƒ€ì¼ */
.tb-field-main input[type="text"],
.tb-field-main textarea,
.tb-field-main select {
  width: 100%;
  padding: 0.875rem 1.125rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 0.75rem;
  color: #ffffff;
  font-size: 0.9375rem;
  transition: all 0.2s;
}

.tb-field-main input[type="text"]:focus,
.tb-field-main textarea:focus,
.tb-field-main select:focus {
  outline: none;
  border-color: #c084fc;
  background: rgba(192, 132, 252, 0.1);
  box-shadow: 0 0 0 3px rgba(192, 132, 252, 0.1);
}

/* Select ì˜µì…˜ ìŠ¤íƒ€ì¼ */
.tb-field-main select option {
  background: #1a1f2e;
  color: #cbd5e1;
  padding: 0.75rem;
}

.tb-field-main select option:hover {
  background: rgba(192, 132, 252, 0.2);
  color: #c084fc;
}

.tb-field-main select option:checked {
  background: #7c3aed;
  color: #ffffff;
}

.tb-field-main textarea {
  resize: vertical;
  min-height: 120px;
  font-family: inherit;
}

.tb-field-main select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2394a3b8' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  padding-right: 2.5rem;
}

.tb-help-text {
  font-size: 0.875rem;
  color: #64748b;
  margin: 0;
}

.tb-field-error {
  font-size: 0.875rem;
  color: #f87171;
  margin: 0;
}

/* ========================================
   Tags Grid
   ======================================== */
.tb-tags-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 0.75rem;
  margin: 0.75rem 0;
}

.tb-tag-checkbox {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.875rem;
  user-select: none;
}

.tb-tag-checkbox:hover {
  background: rgba(255,255,255,0.06);
  border-color: rgba(192,132,252,0.4);
  transform: translateY(-1px);
}

.tb-tag-checkbox input[type="checkbox"] {
  appearance: none;
  width: 18px;
  height: 18px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 4px;
  cursor: pointer;
  position: relative;
  flex-shrink: 0;
  transition: all 0.2s;
  margin: 0;
}

.tb-tag-checkbox input[type="checkbox"]:checked {
  background: linear-gradient(135deg, #c084fc, #7c3aed);
  border-color: #c084fc;
}

.tb-tag-checkbox input[type="checkbox"]:checked::after {
  content: 'âœ“';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 12px;
  font-weight: bold;
}

.tb-tag-checkbox:has(input:checked) {
  background: rgba(192,132,252,0.15);
  border-color: #c084fc;
}

.tb-tag-checkbox:has(input:checked) .tb-tag-label {
  color: #c084fc;
  font-weight: 600;
}

@media (max-width: 768px) {
  .tb-tags-grid {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  }
}

/* ========================================
   ğŸ”¥ í•˜ë‹¨ ë²„íŠ¼
   ======================================== */
.tb-upload-footer {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 1rem;
  padding: 2rem 0;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* ì·¨ì†Œ ë²„íŠ¼ */
.tb-btn-cancel {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.875rem 1.75rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 0.75rem;
  color: #cbd5e1;
  font-size: 1rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s;
}

.tb-btn-cancel:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(255, 255, 255, 0.25);
  color: #ffffff;
  transform: translateY(-1px);
}

.tb-btn-cancel svg {
  flex-shrink: 0;
}

/* ì €ì¥ ë²„íŠ¼ */
.tb-btn-submit {
  display: inline-flex;
  align-items: center;
  gap: 0.625rem;
  padding: 0.875rem 2rem;
  background: linear-gradient(135deg, #c084fc, #7c3aed);
  border: none;
  border-radius: 0.75rem;
  color: #ffffff;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(192, 132, 252, 0.3);
}

.tb-btn-submit:hover {
  background: linear-gradient(135deg, #a855f7, #6d28d9);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(192, 132, 252, 0.4);
}

.tb-btn-submit:active {
  transform: translateY(0);
}

.tb-btn-submit svg {
  flex-shrink: 0;
}

@media (max-width: 640px) {
  .tb-upload-footer {
    flex-direction: column-reverse;
  }
  
  .tb-btn-cancel,
  .tb-btn-submit {
    width: 100%;
    justify-content: center;
  }
}

/* ========================================
   ê²½ê³  ë©”ì‹œì§€
   ======================================== */
.tb-alert-warning {
  padding: 1rem 1.25rem;
  background: rgba(251, 191, 36, 0.1);
  border: 1px solid rgba(251, 191, 36, 0.3);
  border-radius: 0.75rem;
  color: #fbbf24;
  font-size: 0.9375rem;
}

.tb-alert-warning code {
  background: rgba(0, 0, 0, 0.3);
  padding: 0.25rem 0.5rem;
  border-radius: 0.375rem;
  font-family: 'Courier New', monospace;
  font-size: 0.875rem;
}

.tb-form-errors {
  padding: 1rem 1.25rem;
  background: rgba(248, 113, 113, 0.1);
  border: 1px solid rgba(248, 113, 113, 0.3);
  border-radius: 0.75rem;
  color: #f87171;
  margin-bottom: 2rem;
}
</style>
{% endblock %}