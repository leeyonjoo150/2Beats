<!--
  ========================================
  ì›”ë“œì»µ ê²Œì„ í˜ì´ì§€ (World Cup Game)
  ========================================
  - ìŒì•… ì´ìƒí˜• ì›”ë“œì»µ ê²Œì„
  - 2ê°œì˜ ì¹´ë“œ ì¤‘ ì„ íƒí•˜ì—¬ í† ë„ˆë¨¼íŠ¸ ì§„í–‰
  - ì¹´ë“œ í´ë¦­ ì‹œ ë¯¸ë¦¬ë“£ê¸° ì¬ìƒ
  - ìµœì¢… ìš°ìŠ¹ê³¡ ì„ ì • ë° ì €ì¥
-->

{% extends "base.html" %}
{% block title %}2Beats ì´ìƒí˜• ì›”ë“œì»µ{% endblock %}

{% block extra_head %}
<style>
  /* ========================================
     ì „ì—­ ì„¤ì •
     ======================================== */
  body {
    user-select: none;  /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
  }

  /* ========================================
     ì»¨í…Œì´ë„ˆ
     ======================================== */
  .wc-container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    text-align: center;
    padding: 20px;
  }

  /* í˜ì´ì§€ ì œëª© */
  .wc-container h1 {
    margin-bottom: 10px;
    background: linear-gradient(135deg, #ffffff 0%, #c084fc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2.5rem;
    font-weight: 700;
  }

  /* ìƒíƒœ ë°” (ë¼ìš´ë“œ ì •ë³´) */
  .status-bar {
    font-size: 1.2rem;
    margin-bottom: 20px;
    color: rgba(255,255,255,0.7);
  }

  /* ========================================
     ì„¤ì • í™”ë©´
     ======================================== */
  #setup-screen {
    display: block;
    margin-top: 100px;
  }

  /* ì»¤ìŠ¤í…€ ì›”ë“œì»µ ì œëª© */
  .custom-title {
    font-size: 2rem;
    color: #c084fc;
    margin-bottom: 10px;
    font-weight: 700;
  }

  .custom-creator {
    color: rgba(255,255,255,0.6);
    margin-bottom: 30px;
  }

  /* ì„¤ì • ì„ íƒ */
  #setup-screen > div {
    margin: 15px 0;
  }

  #setup-screen label {
    color: rgba(255,255,255,0.8);
    margin-right: 10px;
    font-weight: 500;
  }

  select {
    padding: 10px 20px;
    font-size: 1rem;
    margin: 10px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.05);
    color: white;
    cursor: pointer;
    transition: all 0.2s;
  }

  select:focus {
    outline: none;
    border-color: #c084fc;
    background: rgba(255,255,255,0.08);
  }

  select option {
    background: #120f1f;
    color: white;
  }

  /* ì‹œì‘ ë²„íŠ¼ */
  .btn-start {
    padding: 15px 40px;
    font-size: 1.1rem;
    margin: 20px 10px;
    border-radius: 2rem;
    border: none;
    background: linear-gradient(120deg, #c084fc, #7c3aed);
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 8px 24px rgba(124,58,237,0.35);
  }

  .btn-start:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(124,58,237,0.5);
  }

  /* ========================================
     ê²Œì„ í™”ë©´
     ======================================== */
  #game-screen {
    display: none;
    width: 100%;
  }

  /* ëŒ€ê²° ì»¨í…Œì´ë„ˆ - 2ê°œ ì¹´ë“œ + VS */
  .versus-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 40px;
    margin-top: 30px;
  }

  /* í›„ë³´ ë˜í¼ (ì¹´ë“œ + ì„ íƒ ë²„íŠ¼) */
  .candidate-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
  }

  /* ========================================
     ì¹´ë“œ ìŠ¤íƒ€ì¼ - ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜
     ======================================== */
  .card {
    width: 320px;
    height: 420px;
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 15px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }

  /* ì¹´ë“œ í˜¸ë²„ íš¨ê³¼ */
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(192,132,252,0.3);
    border-color: rgba(192,132,252,0.4);
  }

  /* ì¬ìƒ ì¤‘ì¸ ì¹´ë“œ */
  .card.playing-card {
    border-color: #c084fc;
    box-shadow: 0 0 30px rgba(192,132,252,0.6);
    transform: scale(1.02);
  }

  /* ì•¨ë²” ì´ë¯¸ì§€ */
  .card img {
    width: 100%;
    height: 75%;
    object-fit: cover;
    pointer-events: none;
  }

  /* ì¹´ë“œ ì •ë³´ ì˜ì—­ */
  .card-info {
    padding: 15px;
    background: linear-gradient(to top, rgba(18,15,31,0.9), rgba(255,255,255,0.05));
    height: 25%;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .card-info h3 {
    margin: 0;
    font-size: 1.3rem;
    margin-bottom: 5px;
    color: white;
  }

  .card-info p {
    color: rgba(255,255,255,0.6);
    margin: 0;
    font-size: 0.9rem;
  }

  /* ì¬ìƒ ì•„ì´ì½˜ */
  .play-icon {
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    color: rgba(255,255,255,0.9);
    text-shadow: 0 0 20px rgba(192,132,252,0.8);
    opacity: 0;
    transition: 0.3s;
  }

  .card:hover .play-icon {
    opacity: 1;
  }

  .playing-card .play-icon {
    opacity: 0;  /* ì¬ìƒ ì¤‘ì¼ ë•ŒëŠ” ì•„ì´ì½˜ ìˆ¨ê¹€ */
  }

  /* ========================================
     ì„ íƒ ë²„íŠ¼
     ======================================== */
  .btn-select {
    padding: 15px 40px;
    font-size: 1.1rem;
    background: rgba(255,255,255,0.05);
    color: white;
    border: 2px solid rgba(192,132,252,0.3);
    border-radius: 30px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: bold;
  }

  .btn-select:hover {
    background: linear-gradient(120deg, #c084fc, #7c3aed);
    color: white;
    border-color: #c084fc;
    box-shadow: 0 0 20px rgba(192,132,252,0.5);
    transform: scale(1.05);
  }

  /* VS í…ìŠ¤íŠ¸ */
  .vs-text {
    font-size: 3rem;
    font-weight: bold;
    font-style: italic;
    background: linear-gradient(135deg, #ff3366, #ff6699);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-top: 180px;
    text-shadow: 0 0 30px rgba(255,51,102,0.5);
  }

  /* ì˜¤ë””ì˜¤ ìˆ¨ê¹€ */
  audio {
    display: none;
  }

  /* ========================================
     ê²°ê³¼ í™”ë©´
     ======================================== */
  #result-screen {
    display: none;
    margin-top: 50px;
  }

  #result-screen h2 {
    font-size: 2.5rem;
    margin-bottom: 30px;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* ìš°ìŠ¹ ì¹´ë“œ */
  .winner-card {
    margin: 0 auto 30px;
    transform: scale(1.2);
    border: 4px solid gold;
    box-shadow: 0 0 40px rgba(255, 215, 0, 0.7);
    width: 300px;
    border-radius: 15px;
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(12px);
    padding: 10px;
    animation: winner-glow 2s ease-in-out infinite;
  }

  @keyframes winner-glow {
    0%, 100% {
      box-shadow: 0 0 40px rgba(255, 215, 0, 0.7);
    }
    50% {
      box-shadow: 0 0 60px rgba(255, 215, 0, 1);
    }
  }

  .winner-card img {
    width: 100%;
    border-radius: 10px;
  }

  .winner-card > div {
    padding: 15px;
  }

  .winner-card h3 {
    margin: 0;
    color: white;
  }

  .winner-card p {
    color: rgba(255,255,255,0.7);
    margin: 5px 0 0;
  }

  /* ========================================
     ëª¨ë°”ì¼ ë°˜ì‘í˜•
     ======================================== */
  @media (max-width: 768px) {
    .versus-container {
      flex-direction: column;
      gap: 20px;
    }

    .vs-text {
      margin-top: 0;
      transform: rotate(90deg);
    }

    .card {
      width: 280px;
      height: 380px;
    }

    #setup-screen {
      margin-top: 50px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="wc-container">
  <h1>ğŸµ 2Beats World Cup</h1>

  <!-- ========================================
       ì„¤ì • í™”ë©´
       ======================================== -->
  <div id="setup-screen">
    {% if is_custom %}
      <!-- ì»¤ìŠ¤í…€ ì›”ë“œì»µ -->
      <div class="custom-title">{{ custom_wc.title }}</div>
      <div class="custom-creator">Created by {{ custom_wc.creator.username }}</div>

      <p style="color: rgba(255,255,255,0.7);">ì´ {{ custom_wc.musics.count }}ê³¡ì´ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
      <button class="btn-start" onclick="startCustomGame('{{ custom_wc.access_code }}', {{ custom_wc.musics.count }})">
        ğŸ”¥ ë„ì „í•˜ê¸°
      </button>
    {% else %}
      <!-- ì¼ë°˜ ì›”ë“œì»µ -->
      <h2 style="color: rgba(255,255,255,0.9); margin-bottom: 30px;">ê²Œì„ ì„¤ì •</h2>
      <div>
        <label>ì¥ë¥´: </label>
        <select id="genre-select">
          <option value="all">ì „ì²´ ì¥ë¥´</option>
          <option value="ballad">ë°œë¼ë“œ</option>
          <option value="dance">ëŒ„ìŠ¤</option>
          <option value="hiphop">í™í•©</option>
          <option value="rnb">R&B</option>
          <option value="indie">ì¸ë””</option>
          <option value="ost">OST</option>
        </select>
      </div>
      <div>
        <label>ëª¨ë“œ: </label>
        <select id="mode-select">
          <option value="random">ëœë¤ ë§¤ì¹­</option>
          <option value="rank">ë­í‚¹ ë§¤ì¹­ (ì¸ê¸°ê³¡)</option>
        </select>
      </div>
      <div>
        <label>ë¼ìš´ë“œ: </label>
        <select id="round-select">
          <option value="32">32ê°•</option>
          <option value="16">16ê°•</option>
          <option value="8">8ê°•</option>
          <option value="4">4ê°•</option>
        </select>
      </div>
      <br>
      <button class="btn-start" onclick="startGame()">ê²Œì„ ì‹œì‘!</button>
    {% endif %}
  </div>

  <!-- ========================================
       ê²Œì„ í™”ë©´
       ======================================== -->
  <div id="game-screen">
    <div class="status-bar" id="round-info">16ê°• - 1 / 8</div>

    <div class="versus-container">
      <!-- ì™¼ìª½ í›„ë³´ -->
      <div class="candidate-wrapper">
        <div class="card" id="card-left" onclick="toggleAudio('left')">
          <div class="play-icon">â–¶</div>
          <img id="img-left" src="" alt="cover">
          <div class="card-info">
            <h3 id="title-left">Title</h3>
            <p id="singer-left">Singer</p>
          </div>
        </div>
        <button class="btn-select" onclick="selectMusic('left')">ğŸ‘† ì´ ê³¡ ì„ íƒ</button>
        <audio id="audio-left"></audio>
      </div>

      <!-- VS -->
      <div class="vs-text">VS</div>

      <!-- ì˜¤ë¥¸ìª½ í›„ë³´ -->
      <div class="candidate-wrapper">
        <div class="card" id="card-right" onclick="toggleAudio('right')">
          <div class="play-icon">â–¶</div>
          <img id="img-right" src="" alt="cover">
          <div class="card-info">
            <h3 id="title-right">Title</h3>
            <p id="singer-right">Singer</p>
          </div>
        </div>
        <button class="btn-select" onclick="selectMusic('right')">ğŸ‘† ì´ ê³¡ ì„ íƒ</button>
        <audio id="audio-right"></audio>
      </div>
    </div>
    <p style="margin-top: 20px; color: rgba(255,255,255,0.4); font-size: 0.9rem;">â€» ì•¨ë²” ì»¤ë²„ë¥¼ í´ë¦­í•˜ë©´ ë¯¸ë¦¬ë“£ê¸°ê°€ ì¬ìƒë©ë‹ˆë‹¤.</p>
  </div>

  <!-- ========================================
       ê²°ê³¼ í™”ë©´
       ======================================== -->
  <div id="result-screen">
    <h2>ğŸ† ìµœì¢… ìš°ìŠ¹! ğŸ†</h2>
    <div class="winner-card">
      <img id="img-winner" src="" alt="cover">
      <div>
        <h3 id="title-winner"></h3>
        <p id="singer-winner"></p>
      </div>
    </div>
    <button class="btn-start" onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button>
  </div>
</div>

<!-- ========================================
     JavaScript - ê²Œì„ ë¡œì§
     ======================================== -->
<script>
    let candidates = [];
    let nextRound = [];
    let currentPairIndex = 0;
    let currentRoundName = 16;
    let gameHistory = [];
    let currentCustomCode = null;

    // ì¼ë°˜ ê²Œì„ ì‹œì‘
    async function startGame() {
        const genre = document.getElementById('genre-select').value;
        const sort = document.getElementById('mode-select').value;
        const count = parseInt(document.getElementById('round-select').value);
        currentCustomCode = null;

        await fetchAndStart(`/worldcup/candidates/?genre=${genre}&sort=${sort}&count=${count}`, count);
    }

    // ì»¤ìŠ¤í…€ ê²Œì„ ì‹œì‘
    async function startCustomGame(code, realCount) {
        currentCustomCode = code;
        await fetchAndStart(`/worldcup/candidates/?custom_code=${code}&count=${realCount}`, realCount);
    }

    // ë°ì´í„° ê°€ì ¸ì™€ì„œ ê²Œì„ ì‹œì‘
    async function fetchAndStart(url, explicitCount) {
        try {
            const response = await fetch(url);
            const data = await response.json();

            if (!response.ok) {
                alert(data.error || "ì˜¤ë¥˜ ë°œìƒ");
                return;
            }

            candidates = data.candidates;
            currentRoundName = explicitCount || candidates.length;
            nextRound = [];
            currentPairIndex = 0;
            gameHistory = [];

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';

            updateDisplay();

        } catch (error) {
            console.error(error);
            alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
        }
    }

    // í™”ë©´ ì—…ë°ì´íŠ¸
    function updateDisplay() {
        stopAllAudio();

        const left = candidates[currentPairIndex];
        const right = candidates[currentPairIndex + 1];

        if (!right) {
            nextRound.push(left);
            gameHistory.push({ music_id: left.id, rank: currentRoundName });
            endRound();
            return;
        }

        const defaultImg = "https://via.placeholder.com/300x300?text=No+Image";

        document.getElementById('img-left').src = left.thumbnail_url || defaultImg;
        document.getElementById('title-left').textContent = left.music_title;
        document.getElementById('singer-left').textContent = left.music_singer;
        document.getElementById('audio-left').src = left.file_url || "";

        document.getElementById('img-right').src = right.thumbnail_url || defaultImg;
        document.getElementById('title-right').textContent = right.music_title;
        document.getElementById('singer-right').textContent = right.music_singer;
        document.getElementById('audio-right').src = right.file_url || "";

        const totalMatches = Math.floor(candidates.length / 2);
        const currentMatch = (currentPairIndex / 2) + 1;

        let roundText = `${candidates.length}ê°•`;
        if (candidates.length <= 2) roundText = "ê²°ìŠ¹ì „";
        else if (candidates.length <= 4) roundText = "4ê°•";
        else if (candidates.length <= 8) roundText = "8ê°•";
        else if (candidates.length <= 16) roundText = "16ê°•";

        document.getElementById('round-info').textContent = `${roundText} - ${currentMatch} / ${totalMatches}`;
    }

    // ì˜¤ë””ì˜¤ í† ê¸€
    function toggleAudio(side) {
        const targetAudio = document.getElementById(`audio-${side}`);
        const otherAudio = document.getElementById(`audio-${side === 'left' ? 'right' : 'left'}`);
        const targetCard = document.getElementById(`card-${side}`);
        const otherCard = document.getElementById(`card-${side === 'left' ? 'right' : 'left'}`);

        if (targetAudio.paused) {
            otherAudio.pause();
            otherAudio.currentTime = 0;
            otherCard.classList.remove('playing-card');

            targetAudio.play().catch(e => console.log("ì¬ìƒ ì‹¤íŒ¨:", e));
            targetCard.classList.add('playing-card');
        } else {
            targetAudio.pause();
            targetCard.classList.remove('playing-card');
        }
    }

    // ëª¨ë“  ì˜¤ë””ì˜¤ ì •ì§€
    function stopAllAudio() {
        document.querySelectorAll('audio').forEach(a => {
            a.pause();
            a.currentTime = 0;
        });
        document.querySelectorAll('.card').forEach(c => {
            c.classList.remove('playing-card');
        });
    }

    // ìŒì•… ì„ íƒ
    function selectMusic(side) {
        stopAllAudio();

        const left = candidates[currentPairIndex];
        const right = candidates[currentPairIndex + 1];

        let winner, loser;
        if (side === 'left') {
            winner = left;
            loser = right;
        } else {
            winner = right;
            loser = left;
        }

        nextRound.push(winner);

        const rank = (candidates.length <= 2) ? 2 : candidates.length;
        gameHistory.push({ music_id: loser.id, rank: rank });

        currentPairIndex += 2;

        if (currentPairIndex >= candidates.length) {
            endRound();
        } else {
            updateDisplay();
        }
    }

    // ë¼ìš´ë“œ ì¢…ë£Œ
    function endRound() {
        if (candidates.length <= 2) {
            const finalWinner = nextRound[0];
            gameHistory.push({ music_id: finalWinner.id, rank: 1 });
            sendResultToServer(finalWinner);
        } else {
            candidates = nextRound;
            nextRound = [];
            currentPairIndex = 0;
            updateDisplay();
        }
    }

    // ê²°ê³¼ ì„œë²„ ì „ì†¡
    async function sendResultToServer(winner) {
        try {
            const user_uid = "{% if user.is_authenticated %}{{ user.pk }}{% else %}{% endif %}";
            const final_uid = user_uid ? user_uid : null;

            const response = await fetch('/worldcup/save/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_uid: final_uid,
                    total_rounds: 16,
                    results: gameHistory,
                    custom_code: currentCustomCode
                })
            });

            const data = await response.json();
            if (response.ok) {
                window.location.href = `/worldcup/result/${data.game_id}/`;
            } else {
                alert("ì €ì¥ ì‹¤íŒ¨: " + JSON.stringify(data));
            }
        } catch (e) {
            console.error("ì €ì¥ ì¤‘ ì—ëŸ¬", e);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        }
    }
</script>
{% endblock %}
