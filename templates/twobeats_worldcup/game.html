{% extends "base.html" %}
{% block title %}나만의 월드컵 | 2Beats{% endblock %}

{% block extra_head %}
<style>
  .wc-shell { max-width: 1100px; margin: 0 auto; }
  .wc-header h1 {
    margin: 0 0 8px;
    background: linear-gradient(135deg, #e5d9ff 0%, #c084fc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-family: "Space Grotesk", "Pretendard", "Noto Sans KR", sans-serif;
    letter-spacing: -0.02em;
  }
  .wc-header p { margin: 0; color: var(--muted); }
  .wc-card {
    background: linear-gradient(140deg, rgba(124,58,237,0.12), rgba(192,132,252,0.08), var(--card));
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 18px;
    box-shadow: 0 22px 70px rgba(0,0,0,0.55);
    padding: 20px;
  }
  .wc-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 12px 18px;
    border-radius: 14px;
    font-weight: 700;
    border: 1px solid transparent;
    cursor: pointer;
    transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.15s ease;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: #0b1220;
    box-shadow: 0 18px 42px rgba(124,58,237,0.32);
  }
  .wc-btn.secondary {
    background: transparent;
    color: var(--text);
    border-color: var(--border);
    box-shadow: none;
  }
  .wc-btn:hover { transform: translateY(-1px); }
  .wc-btn:active { transform: translateY(0); opacity: 0.9; }
  input, select {
    background: #0c0a18;
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
    width: 100%;
  }
  input:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(124,58,237,0.2);
  }
  .versus-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 40px;
    margin-top: 30px;
    flex-wrap: wrap;
  }
  .candidate-wrapper { display: flex; flex-direction: column; align-items: center; gap: 12px; }
  .card-visual {
    width: 320px;
    height: 420px;
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 15px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }
  .card-visual:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(192,132,252,0.3);
    border-color: rgba(192,132,252,0.4);
  }
  .card-visual.playing {
    border-color: #c084fc;
    box-shadow: 0 0 30px rgba(192,132,252,0.6);
    transform: scale(1.02);
  }
  .card-visual img { width: 100%; height: 75%; object-fit: cover; }
  .card-info {
    padding: 15px;
    background: linear-gradient(to top, rgba(18,15,31,0.9), rgba(255,255,255,0.05));
    height: 25%;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .card-info h3 { margin: 0 0 5px; color: var(--text); }
  .card-info p { margin: 0; color: var(--muted); font-size: 0.95rem; }
  .play-icon {
    position: absolute;
    top: 40%; left: 50%; transform: translate(-50%, -50%);
    font-size: 3rem; color: rgba(255,255,255,0.9);
    text-shadow: 0 0 20px rgba(192,132,252,0.8);
    opacity: 0; transition: 0.3s;
  }
  .card-visual:hover .play-icon { opacity: 1; }
  .playing .play-icon { opacity: 0; }
  .status-bar { font-size: 1.1rem; margin-bottom: 10px; color: var(--muted); text-align:center; }
</style>
{% endblock %}

{% block content %}
<div class="wc-shell">
  <div class="card wc-header">
    <h1>나만의 2Beats World Cup</h1>
    <p>장르와 라운드를 선택해 음악 월드컵을 플레이하거나, 커스텀 월드컵을 시작하세요.</p>
  </div>

  <div id="setup-screen" class="wc-card">
    <div style="margin: 0 0 14px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <a class="wc-btn secondary" href="{% url 'twobeats_worldcup:create_page' %}">만들기 페이지로</a>
      <a class="wc-btn secondary" href="{% url 'twobeats_worldcup:ranking' %}">랭킹 보기</a>
    </div>

    {% if is_custom %}
      <div style="margin-bottom:12px;">
        <div style="font-size:1.4rem; font-weight:700; color:var(--text);">{{ custom_wc.title }}</div>
        <div class="muted">Created by {{ custom_wc.creator.username }} · {{ custom_wc.musics.count }}곡</div>
      </div>
      <button class="wc-btn" onclick="startCustomGame('{{ custom_wc.access_code }}', {{ custom_wc.musics.count }})">커스텀 게임 시작</button>
    {% else %}
      <div style="display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div>
          <label class="muted">장르</label>
          <select id="genre-select">
            <option value="all">전체 장르</option>
            <option value="ballad">발라드</option>
            <option value="dance">댄스</option>
            <option value="hiphop">힙합</option>
            <option value="rnb">R&B</option>
            <option value="indie">인디</option>
            <option value="ost">OST</option>
          </select>
        </div>
        <div>
          <label class="muted">모드</label>
          <select id="mode-select">
            <option value="random">랜덤 매칭</option>
            <option value="rank">순위 매칭 (듣기수)</option>
          </select>
        </div>
        <div>
          <label class="muted">라운드</label>
          <select id="round-select">
            <option value="32">32강</option>
            <option value="16">16강</option>
            <option value="8">8강</option>
            <option value="4">4강</option>
          </select>
        </div>
      </div>
      <div style="margin-top:16px; text-align:center;">
        <button class="wc-btn" onclick="startGame()">게임 시작</button>
      </div>
    {% endif %}
  </div>

  <div id="game-screen" class="wc-card" style="display:none;">
    <div class="status-bar" id="round-info">16강 - 1 / 8</div>
    <div class="versus-container">
      <div class="candidate-wrapper">
        <div class="card-visual" id="card-left" onclick="toggleAudio('left')">
          <div class="play-icon">▶</div>
          <img id="img-left" src="" alt="left cover">
          <div class="card-info">
            <h3 id="title-left">Title</h3>
            <p id="singer-left">Singer</p>
          </div>
        </div>
        <button class="wc-btn secondary" onclick="selectMusic('left')">왼쪽 선택</button>
        <audio id="audio-left"></audio>
      </div>

      <div class="candidate-wrapper" style="min-width:90px; align-items:center;">
        <div class="vs-text" style="font-size:3rem; font-weight:800; color:var(--accent);">VS</div>
      </div>

      <div class="candidate-wrapper">
        <div class="card-visual" id="card-right" onclick="toggleAudio('right')">
          <div class="play-icon">▶</div>
          <img id="img-right" src="" alt="right cover">
          <div class="card-info">
            <h3 id="title-right">Title</h3>
            <p id="singer-right">Singer</p>
          </div>
        </div>
        <button class="wc-btn secondary" onclick="selectMusic('right')">오른쪽 선택</button>
        <audio id="audio-right"></audio>
      </div>
    </div>
    <p class="muted" style="text-align:center; margin-top:14px; font-size:0.9rem;">썸네일을 클릭하면 미리 듣기가 재생됩니다.</p>
  </div>
</div>

<script>
  let candidates = [];
  let nextRound = [];
  let currentPairIndex = 0;
  let currentRoundName = 16;
  let initialRound = 16;
  let gameHistory = [];
  let currentCustomCode = null;

  async function startGame() {
    const genre = document.getElementById('genre-select').value;
    const sort = document.getElementById('mode-select').value;
    const count = parseInt(document.getElementById('round-select').value);
    currentCustomCode = null;
    initialRound = count;
    await fetchAndStart(`/worldcup/candidates/?genre=${genre}&sort=${sort}&count=${count}`, count);
  }

  async function startCustomGame(code, realCount) {
    currentCustomCode = code;
    initialRound = realCount;
    await fetchAndStart(`/worldcup/candidates/?custom_code=${code}&count=${realCount}`, realCount);
  }

  async function fetchAndStart(url, explicitCount) {
    try {
      const response = await fetch(url);
      const data = await response.json();
      if (!response.ok) {
        alert(data.error || "오류가 발생했습니다");
        return;
      }
      candidates = data.candidates;
      currentRoundName = explicitCount || candidates.length;
      nextRound = [];
      currentPairIndex = 0;
      gameHistory = [];
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
      updateDisplay();
    } catch (error) {
      console.error(error);
      alert("서버 통신 오류");
    }
  }

  function updateDisplay() {
    stopAllAudio();
    const left = candidates[currentPairIndex];
    const right = candidates[currentPairIndex + 1];

    if (!right) {
      nextRound.push(left);
      gameHistory.push({ music_id: left.id, rank: currentRoundName });
      endRound();
      return;
    }

    const defaultImg = "https://via.placeholder.com/300x300?text=No+Image";

    document.getElementById('img-left').src = left.thumbnail_url || defaultImg;
    document.getElementById('title-left').textContent = left.music_title;
    document.getElementById('singer-left').textContent = left.music_singer;
    document.getElementById('audio-left').src = left.file_url || "";

    document.getElementById('img-right').src = right.thumbnail_url || defaultImg;
    document.getElementById('title-right').textContent = right.music_title;
    document.getElementById('singer-right').textContent = right.music_singer;
    document.getElementById('audio-right').src = right.file_url || "";

    const totalMatches = Math.floor(candidates.length / 2);
    const currentMatch = (currentPairIndex / 2) + 1;
    let roundText = `${candidates.length}강`;
    if (candidates.length <= 2) roundText = "결승";
    else if (candidates.length <= 4) roundText = "4강";
    else if (candidates.length <= 8) roundText = "8강";
    else if (candidates.length <= 16) roundText = "16강";

    document.getElementById('round-info').textContent = `${roundText} - ${currentMatch} / ${totalMatches}`;
  }

  function toggleAudio(side) {
    const targetAudio = document.getElementById(`audio-${side}`);
    const otherAudio = document.getElementById(`audio-${side === 'left' ? 'right' : 'left'}`);
    const targetCard = document.getElementById(`card-${side}`);
    const otherCard = document.getElementById(`card-${side === 'left' ? 'right' : 'left'}`);

    if (targetAudio.paused) {
      otherAudio.pause();
      otherAudio.currentTime = 0;
      otherCard.classList.remove('playing');
      targetAudio.play().catch(() => {});
      targetCard.classList.add('playing');
    } else {
      targetAudio.pause();
      targetCard.classList.remove('playing');
    }
  }

  function stopAllAudio() {
    document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; });
    document.querySelectorAll('.card-visual').forEach(c => c.classList.remove('playing'));
  }

  function selectMusic(side) {
    stopAllAudio();
    const left = candidates[currentPairIndex];
    const right = candidates[currentPairIndex + 1];
    let winner, loser;
    if (side === 'left') { winner = left; loser = right; }
    else { winner = right; loser = left; }

    nextRound.push(winner);
    const rank = (candidates.length <= 2) ? 2 : candidates.length;
    gameHistory.push({ music_id: loser.id, rank: rank });

    currentPairIndex += 2;
    if (currentPairIndex >= candidates.length) {
      endRound();
    } else {
      updateDisplay();
    }
  }

  function endRound() {
    if (candidates.length <= 2) {
      const finalWinner = nextRound[0];
      gameHistory.push({ music_id: finalWinner.id, rank: 1 });
      sendResultToServer(finalWinner);
    } else {
      candidates = nextRound;
      nextRound = [];
      currentPairIndex = 0;
      updateDisplay();
    }
  }

  async function sendResultToServer(winner) {
    try {
      const user_uid = "{% if user.is_authenticated %}{{ user.pk }}{% else %}{% endif %}";
      const final_uid = user_uid ? user_uid : null;
      const response = await fetch('/worldcup/save/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_uid: final_uid,
          total_rounds: initialRound,
          results: gameHistory,
          custom_code: currentCustomCode
        })
      });
      const data = await response.json();
      if (response.ok) {
        window.location.href = `/worldcup/result/${data.game_id}/`;
      } else {
        alert("오류: " + JSON.stringify(data));
      }
    } catch (e) {
      console.error(e);
      alert("서버 통신 오류");
    }
  }
</script>
{% endblock %}
