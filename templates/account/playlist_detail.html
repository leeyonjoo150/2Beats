{% extends "base.html" %}
{% block title %}í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ | 2beats{% endblock %}

{% block extra_head %}
<style>
    /* === í•˜ë‹¨ ë¡œì»¬ í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ === */
    #local-player {
        position: fixed;
        bottom: 0; left: 0; right: 0;
        background: rgba(18, 15, 31, 0.98);
        border-top: 1px solid #1f1b2d;
        padding: 12px 24px;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.6);
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        z-index: 1000;
        color: #f7f8ff;
        backdrop-filter: blur(10px);
    }
    #local-player.active { display: block; }

    .player-content {
        max-width: 1000px; margin: 0 auto;
        display: grid; grid-template-columns: 200px 1fr 150px; /* [ìˆ˜ì •] ìš°ì¸¡ ë³¼ë¥¨ ê³µê°„ í™•ë³´ */
        gap: 2rem; align-items: center;
    }

    /* ì•¨ë²”ì•„íŠ¸ & ì •ë³´ */
    .player-info { display: flex; gap: 12px; align-items: center; overflow: hidden; }
    .player-thumb {
        width: 48px; height: 48px; border-radius: 8px; object-fit: cover;
        background: #333; flex-shrink: 0;
    }
    .player-text { overflow: hidden; white-space: nowrap; }
    .player-title { margin: 0; font-size: 0.95rem; font-weight: 700; text-overflow: ellipsis; overflow: hidden; }
    .player-artist { margin: 0; font-size: 0.8rem; color: #9ca3af; text-overflow: ellipsis; overflow: hidden; }

    /* ì»¨íŠ¸ë¡¤ëŸ¬ */
    .player-controls { display: flex; flex-direction: column; align-items: center; gap: 6px; }
    .control-btns { display: flex; gap: 20px; align-items: center; }
    
    .btn-control {
        background: none; border: none; color: #f7f8ff; cursor: pointer; font-size: 1.2rem;
        padding: 4px; transition: color 0.2s; display: flex; align-items: center; justify-content: center;
    }
    .btn-control:hover { color: #c084fc; }
    .btn-play { font-size: 2.2rem; color: #c084fc; }
    
    /* ì§„í–‰ë°” */
    .progress-wrap { width: 100%; display: flex; align-items: center; gap: 10px; font-size: 0.75rem; color: #9ca3af; }
    .progress-bar {
        flex: 1; height: 4px; background: rgba(255,255,255,0.1);
        border-radius: 2px; cursor: pointer; position: relative;
    }
    .progress-fill {
        height: 100%; background: #c084fc; border-radius: 2px; width: 0%;
        position: absolute; top: 0; left: 0;
    }

    /* [ì¶”ê°€] ë³¼ë¥¨ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
    .player-volume {
        display: flex; align-items: center; justify-content: flex-end; gap: 10px;
    }
    .volume-slider {
        width: 80px; height: 4px;
        -webkit-appearance: none; appearance: none;
        background: rgba(255,255,255,0.2);
        border-radius: 2px; cursor: pointer; outline: none;
    }
    .volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none;
        width: 12px; height: 12px; background: #c084fc;
        border-radius: 50%; cursor: pointer;
    }
    .volume-slider::-moz-range-thumb {
        width: 12px; height: 12px; background: #c084fc;
        border-radius: 50%; cursor: pointer; border: none;
    }

    /* ì „ì²´ ì¬ìƒ ë²„íŠ¼ */
    .btn-play-all {
        display: inline-flex; align-items: center; gap: 8px;
        background: linear-gradient(135deg, #c084fc, #7c3aed);
        color: white; border: none; padding: 10px 20px;
        border-radius: 24px; font-weight: 700; cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 15px rgba(124,58,237,0.3);
    }
    .btn-play-all:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(124,58,237,0.4);
    }

    /* ë¦¬ìŠ¤íŠ¸ ë‚´ ì¬ìƒ ë²„íŠ¼ */
    .btn-list-play {
        width: 32px; height: 32px; border-radius: 50%;
        background: rgba(192,132,252,0.1); color: #c084fc;
        border: 1px solid rgba(192,132,252,0.2);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s; padding-left: 3px;
    }
    .btn-list-play:hover {
        background: #c084fc; color: #0b1220;
    }
    .playing-row { background: rgba(192,132,252,0.1) !important; }

    @media (max-width: 768px) {
        .player-content { grid-template-columns: 1fr auto; gap: 1rem; }
        .player-controls { display: none; }
        .player-volume { display: none; } /* ëª¨ë°”ì¼ì—ì„œ ë³¼ë¥¨ ìˆ¨ê¹€ */
    }
</style>
{% endblock %}

{% block content %}
  <div style="margin-bottom:10px;">
    <a class="muted" href="{% url 'mylist' %}?tab={{ kind }}">â† ë§ˆì´ ë¦¬ìŠ¤íŠ¸ë¡œ</a>
  </div>

  <div class="card" style="margin-bottom:14px;">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
      <div>
        <p class="pill-label" style="margin:0 0 8px;">{% if is_music %}ìŒì•…{% else %}ì˜ìƒ{% endif %} í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</p>
        <h1 style="margin:0 0 6px;">{{ playlist.folder_name }}</h1>
        <p class="muted" style="margin:0;">
            ì´ {{ items.count }}ê³¡ | ìƒì„±ì¼ {{ playlist.created_at|date:"Y-m-d" }}
        </p>
      </div>
      
      {% if is_music and items %}
      <div>
          <button class="btn-play-all" onclick="playAll()">
              <span style="font-size:1.1rem;">â–¶</span> ì „ì²´ ì¬ìƒ
          </button>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="card" style="margin-bottom:100px;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
      <h3 style="margin:0;">íŠ¸ë™ ëª©ë¡</h3>
      {% if items %}
        <span class="muted">ìˆœì„œë¥¼ ë³€ê²½í•˜ë ¤ë©´ ìˆ«ìë¥¼ ìˆ˜ì •í•˜ê³  ì €ì¥ì„ ëˆ„ë¥´ì„¸ìš”.</span>
      {% endif %}
    </div>

    {% if items %}
      <form method="post" action="">
        {% csrf_token %}
        <input type="hidden" name="action" value="reorder">
        <table id="playlist-table">
          <thead>
            <tr>
              <th style="width: 50px; text-align:center;"></th>
              <th style="width: 70px;">ìˆœì„œ</th>
              <th>ì œëª©</th>
              <th>ì•„í‹°ìŠ¤íŠ¸</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
              <tr id="track-row-{{ forloop.counter0 }}">
                <td style="text-align:center;">
                  {% if is_music and item.music.music_root %}
                    <button type="button" class="btn-list-play" onclick="playTrack({{ forloop.counter0 }})">â–¶</button>
                  {% endif %}
                </td>
                <td>
                    <input type="number" name="order_{{ item.id }}" value="{{ item.order }}" min="1" 
                           style="width:50px; padding:6px; border-radius:8px; border:1px solid var(--border); background:#0c0a18; color:var(--text); text-align:center;">
                </td>
                <td>
                  {% if is_music %}
                    <a href="{% url 'music_explore:detail' item.music.id %}" style="font-weight:bold; color:var(--text);">{{ item.music.music_title }}</a>
                  {% else %}
                    <a href="{% url 'video_explore:video_detail' item.video.id %}" style="font-weight:bold; color:var(--text);">{{ item.video.video_title }}</a>
                  {% endif %}
                </td>
                <td class="muted">
                  {% if is_music %}
                    {{ item.music.music_singer }}
                  {% else %}
                    {{ item.video.video_singer }}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <div style="margin-top:16px; text-align:right;">
          <button type="submit" class="btn btn-primary" style="border:none;">ìˆœì„œ ì €ì¥</button>
        </div>
      </form>
    {% else %}
      <div style="text-align:center; padding:40px 0; color:#999;">
        <p style="font-size:2rem; margin-bottom:10px;">ğŸ“­</p>
        <p>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    {% endif %}
  </div>

  <div id="local-player">
    <div class="player-content">
        <div class="player-info">
            <img id="lp-thumb" class="player-thumb" src="" style="display:none;">
            <div id="lp-thumb-default" class="player-thumb" style="display:flex; align-items:center; justify-content:center;">ğŸµ</div>
            <div class="player-text">
                <h4 id="lp-title" class="player-title">ì¬ìƒ ì¤‘ì¸ ê³¡ ì—†ìŒ</h4>
                <p id="lp-artist" class="player-artist">-</p>
            </div>
        </div>
        
        <div class="player-controls">
            <div class="control-btns">
                <button class="btn-control" onclick="playPrev()" title="ì´ì „ ê³¡">â®</button>
                <button class="btn-control btn-play" id="lp-playbtn" onclick="togglePlay()">â–¶</button>
                <button class="btn-control" onclick="playNext()" title="ë‹¤ìŒ ê³¡">â­</button>
            </div>
            <div class="progress-wrap">
                <span id="lp-current">0:00</span>
                <div class="progress-bar" id="lp-progress-bar" onclick="seek(event)">
                    <div class="progress-fill" id="lp-progress-fill"></div>
                </div>
                <span id="lp-duration">0:00</span>
            </div>
        </div>

        <div class="player-volume">
            <button class="btn-control" id="lp-mute-btn" onclick="toggleMute()" title="ìŒì†Œê±°">ğŸ”Š</button>
            <input type="range" class="volume-slider" id="lp-volume" 
                   min="0" max="1" step="0.05" value="1" oninput="setVolume(this.value)">
        </div>
    </div>
  </div>
  
  <audio id="lp-audio"></audio>

  <script>
    // 1. í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë°ì´í„° êµ¬ì„±
    const playlistData = [
      {% for item in items %}
        {% if is_music and item.music.music_root %}
        {
            index: {{ forloop.counter0 }},
            title: "{{ item.music.music_title|escapejs }}",
            artist: "{{ item.music.music_singer|escapejs }}",
            url: "{{ item.music.music_root.url }}",
            thumb: "{% if item.music.music_thumbnail %}{{ item.music.music_thumbnail.url }}{% endif %}"
        },
        {% endif %}
      {% endfor %}
    ];

    let currentIndex = -1;
    let isPlaying = false;
    let lastVolume = 1; // ìŒì†Œê±° í•´ì œ ì‹œ ì´ì „ ë³¼ë¥¨ ê¸°ì–µìš©

    const audio = document.getElementById('lp-audio');
    const player = document.getElementById('local-player');
    const playBtn = document.getElementById('lp-playbtn');
    const titleEl = document.getElementById('lp-title');
    const artistEl = document.getElementById('lp-artist');
    const thumbEl = document.getElementById('lp-thumb');
    const thumbDefEl = document.getElementById('lp-thumb-default');
    const progressFill = document.getElementById('lp-progress-fill');
    const progressBar = document.getElementById('lp-progress-bar');
    const currTimeEl = document.getElementById('lp-current');
    const durTimeEl = document.getElementById('lp-duration');
    
    // [ì¶”ê°€] ë³¼ë¥¨ ì—˜ë¦¬ë¨¼íŠ¸
    const volSlider = document.getElementById('lp-volume');
    const muteBtn = document.getElementById('lp-mute-btn');

    // 2. ì „ì²´ ì¬ìƒ
    function playAll() {
        if (playlistData.length > 0) {
            playTrack(0);
        } else {
            alert("ì¬ìƒí•  ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    // 3. íŠ¹ì • íŠ¸ë™ ì¬ìƒ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    function playTrack(index) {
        if (index < 0 || index >= playlistData.length) return;

        currentIndex = index;
        const track = playlistData[index];

        // UI ì—…ë°ì´íŠ¸
        titleEl.textContent = track.title;
        artistEl.textContent = track.artist;
        
        if (track.thumb) {
            thumbEl.src = track.thumb;
            thumbEl.style.display = 'block';
            thumbDefEl.style.display = 'none';
        } else {
            thumbEl.style.display = 'none';
            thumbDefEl.style.display = 'flex';
        }

        // í…Œì´ë¸” í•˜ì´ë¼ì´íŠ¸
        document.querySelectorAll('tbody tr').forEach(tr => tr.classList.remove('playing-row'));
        const row = document.getElementById(`track-row-${track.index}`);
        if(row) row.classList.add('playing-row');

        // í”Œë ˆì´ì–´ í‘œì‹œ ë° ì¬ìƒ
        player.classList.add('active');
        audio.src = track.url;
        // ë³¼ë¥¨ ì´ˆê¸°í™” (ê¸°ì¡´ ê°’ ìœ ì§€)
        audio.volume = volSlider.value;
        
        audio.play()
            .then(() => {
                isPlaying = true;
                updatePlayButton();
            })
            .catch(err => console.log("ì¬ìƒ ì˜¤ë¥˜:", err));
    }

    // 4. ë‹¤ìŒ/ì´ì „
    function playNext() {
        if (currentIndex < playlistData.length - 1) {
            playTrack(currentIndex + 1);
        } else {
            isPlaying = false;
            updatePlayButton();
        }
    }

    function playPrev() {
        if (audio.currentTime > 3) {
            audio.currentTime = 0;
            return;
        }
        if (currentIndex > 0) {
            playTrack(currentIndex - 1);
        }
    }

    // 5. ì˜¤ë””ì˜¤ ì´ë²¤íŠ¸
    audio.addEventListener('ended', () => {
        playNext();
    });

    function togglePlay() {
        if (audio.paused) {
            audio.play();
            isPlaying = true;
        } else {
            audio.pause();
            isPlaying = false;
        }
        updatePlayButton();
    }

    function updatePlayButton() {
        playBtn.textContent = isPlaying ? 'â¸' : 'â–¶';
    }

    audio.addEventListener('timeupdate', () => {
        if (audio.duration) {
            const percent = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = percent + '%';
            currTimeEl.textContent = formatTime(audio.currentTime);
            durTimeEl.textContent = formatTime(audio.duration);
        }
    });

    function seek(e) {
        if (!audio.duration) return;
        const width = progressBar.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        audio.currentTime = (clickX / width) * duration;
    }

    function formatTime(s) {
        const min = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return min + ':' + (sec < 10 ? '0' + sec : sec);
    }

    // 6. [ì¶”ê°€] ë³¼ë¥¨ ì œì–´ ë¡œì§
    function setVolume(val) {
        audio.volume = val;
        updateVolumeIcon(val);
    }

    function toggleMute() {
        if (audio.volume > 0) {
            lastVolume = audio.volume; // í˜„ì¬ ë³¼ë¥¨ ê¸°ì–µ
            audio.volume = 0;
            volSlider.value = 0;
        } else {
            // ë³µêµ¬
            audio.volume = lastVolume > 0 ? lastVolume : 0.5;
            volSlider.value = audio.volume;
        }
        updateVolumeIcon(audio.volume);
    }

    function updateVolumeIcon(val) {
        if (val == 0) muteBtn.textContent = 'ğŸ”‡';
        else if (val < 0.5) muteBtn.textContent = 'ğŸ”‰';
        else muteBtn.textContent = 'ğŸ”Š';
    }
  </script>
{% endblock %}